<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Four Pillars Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 2.2em; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); }
        .input-section { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 30px; flex-wrap: nowrap; }
        .date-input { padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        .date-input:focus { outline: none; border-color: #667eea; }
        .search-btn { padding: 12px 25px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: transform 0.3s; }
        .search-btn:hover { transform: translateY(-2px); }
        .result-section { display: none; margin-top: 30px; }
        .saju-box { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .saju-title { font-size: 1.5em; margin-bottom: 15px; font-weight: bold; }
        .saju-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(3, 1fr); gap: 2px; margin-bottom: 15px; max-width: 500px; margin-left: auto; margin-right: auto; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 8px; background: rgba(255, 255, 255, 0.1); }
        .grid-cell { background: rgba(255, 255, 255, 0.3); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 6px; padding: 8px 4px; text-align: center; font-weight: bold; min-height: 45px; display: flex; align-items: center; justify-content: center; }
        .label-cell { font-size: 0.8em; opacity: 0.9; }
        .stem-cell, .branch-cell { font-size: 0.85em; color: white; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        .wood { background-color: #228B22 !important; }
        .fire { background-color: #DC143C !important; }
        .earth { background-color: #DAA520 !important; }
        .metal { background-color: #C0C0C0 !important; color: #333 !important; }
        .water { background-color: #191970 !important; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .info-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-left: 4px solid #667eea; }
        .info-title { color: #2c3e50; font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .info-content { color: #555; line-height: 1.6; }
        .fortune-period { padding: 10px; margin: 5px 0; border-radius: 8px; border: 2px solid transparent; }
        .fortune-past { background-color: #f8f9fa; color: #6c757d; opacity: 0.7; }
        .fortune-current { background-color: #e3f2fd; border-color: #2196f3; color: #0d47a1; font-weight: bold; }
        .fortune-future { background-color: #f3e5f5; color: #7b1fa2; }
        .fortune-title { font-weight: bold; font-size: 0.9em; }
        .fortune-elements { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .fortune-element { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .error { background-color: #ffe6e6; color: #d8000c; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .inseong-section { margin-top: 30px; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-left: 4px solid #667eea; }
        .period-selector { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #fortuneChart, #wealthChart, #careerChart, #loveChart { margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; display: block; width: 100%; }
        .tab-container { display: flex; margin: 20px 0; border-bottom: 2px solid #eee; background: #f8f9fa; border-radius: 8px 8px 0 0; overflow: hidden; }
        .tab-btn { flex: 1; padding: 15px 20px; border: none; background: transparent; color: #666; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; }
        .tab-btn.active { background: white; color: #667eea; border-bottom-color: #667eea; font-weight: bold; }
        .tab-content { display: none; padding: 20px 0; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .input-section { flex-direction: column; gap: 10px; } .date-input { width: 100%; max-width: 200px; } .tab-btn { font-size: 12px; padding: 12px 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóìÔ∏è Four Pillars Calculator</h1>
        <div class="input-section">
            <select class="date-input" id="dayInput"></select>
            <select class="date-input" id="monthInput"></select>
            <select class="date-input" id="yearInput"></select>
            <select class="date-input" id="genderInput">
                <option value="">Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            <input type="time" class="date-input" id="timeInput" placeholder="Optional">
            <button class="search-btn" onclick="calculateSaju()">Calculate</button>
        </div>
        
        <div class="result-section" id="resultSection">
            <div class="saju-box">
                <div class="saju-title">Four Pillars</div>
                <div class="saju-grid">
                    <div class="grid-cell label-cell">Hour</div>
                    <div class="grid-cell label-cell">Day</div>
                    <div class="grid-cell label-cell">Month</div>
                    <div class="grid-cell label-cell">Year</div>
                    <div class="grid-cell stem-cell" id="hourStem">-</div>
                    <div class="grid-cell stem-cell" id="dayStem">-</div>
                    <div class="grid-cell stem-cell" id="monthStem">-</div>
                    <div class="grid-cell stem-cell" id="yearStem">-</div>
                    <div class="grid-cell branch-cell" id="hourBranch">-</div>
                    <div class="grid-cell branch-cell" id="dayBranch">-</div>
                    <div class="grid-cell branch-cell" id="monthBranch">-</div>
                    <div class="grid-cell branch-cell" id="yearBranch">-</div>
                </div>
                <div id="selectedDate" style="font-size: 1.1em; opacity: 0.9;"></div>
            </div>
            
            <div class="info-grid">
                <div class="info-card" id="fortuneCard" style="display: none;">
                    <div class="info-title">üîÆ Great Fortune</div>
                    <div class="info-content" id="fortuneInfo"></div>
                </div>
                <div class="info-card" id="yearlyCard">
                    <div class="info-title">üìä Yearly Fortune</div>
                    <div class="info-content" id="yearlyInfo"></div>
                </div>
            </div>

            <div class="inseong-section" id="inseongSection" style="display: none;">
                <div class="info-title">üìà Fortune Analysis</div>
                <div class="period-selector">
                    <label>Analysis Period:</label>
                    <select class="date-input" id="analysisRange" style="width: 200px;">
                        <option value="3">3 Years (Current ¬± 1)</option>
                        <option value="5" selected>5 Years (Current ¬± 2)</option>
                        <option value="7">7 Years (Current ¬± 3)</option>
                        <option value="10">10 Years (Current ¬± 4)</option>
                    </select>
                </div>
                
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('study')">üìö Study</button>
                    <button class="tab-btn" onclick="switchTab('wealth')">üí∞ Wealth</button>
                    <button class="tab-btn" onclick="switchTab('career')">üè¢ Career</button>
                    <button class="tab-btn" onclick="switchTab('love')">üíï Love</button>
                </div>
                
                <div class="tab-content active" id="studyTab">
                    <button class="search-btn" onclick="showStudyFortune()">Generate Graph</button>
                    <canvas id="fortuneChart" style="display:none; height: 400px;"></canvas>
                </div>
                <div class="tab-content" id="wealthTab">
                    <button class="search-btn" onclick="showWealthFortune()">Generate Wealth Graph</button>
                    <canvas id="wealthChart" style="display:none; height: 400px;"></canvas>
                </div>
                <div class="tab-content" id="careerTab">
                    <button class="search-btn" onclick="showCareerFortune()">Generate Career Graph</button>
                    <canvas id="careerChart" style="display:none; height: 400px;"></canvas>
                </div>
                <div class="tab-content" id="loveTab">
                    <button class="search-btn" onclick="showLoveFortune()">Generate Love Graph</button>
                    <canvas id="loveChart" style="display:none; height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tianGanEn = ['Yang Wood', 'Yin Wood', 'Yang Fire', 'Yin Fire', 'Yang Earth', 'Yin Earth', 'Yang Metal', 'Yin Metal', 'Yang Water', 'Yin Water'];
        const diZhiEn = ['Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'];
        const elementClass = { 'Wood': 'wood', 'Fire': 'fire', 'Earth': 'earth', 'Metal': 'metal', 'Water': 'water' };
        const wuxing = { 'Yang Wood': 'Wood', 'Yin Wood': 'Wood', 'Yang Fire': 'Fire', 'Yin Fire': 'Fire', 'Yang Earth': 'Earth', 'Yin Earth': 'Earth', 'Yang Metal': 'Metal', 'Yin Metal': 'Metal', 'Yang Water': 'Water', 'Yin Water': 'Water', 'Rat': 'Water', 'Ox': 'Earth', 'Tiger': 'Wood', 'Rabbit': 'Wood', 'Dragon': 'Earth', 'Snake': 'Fire', 'Horse': 'Fire', 'Goat': 'Earth', 'Monkey': 'Metal', 'Rooster': 'Metal', 'Dog': 'Earth', 'Pig': 'Water' };
        const sipsinMapping = { jeongIn: {'Yang Wood': 'Yin Water', 'Yin Wood': 'Yang Water', 'Yang Fire': 'Yin Wood', 'Yin Fire': 'Yang Wood', 'Yang Earth': 'Yin Fire', 'Yin Earth': 'Yang Fire', 'Yang Metal': 'Yin Earth', 'Yin Metal': 'Yang Earth', 'Yang Water': 'Yin Metal', 'Yin Water': 'Yang Metal'}, pyeonIn: {'Yang Wood': 'Yang Water', 'Yin Wood': 'Yin Water', 'Yang Fire': 'Yang Wood', 'Yin Fire': 'Yin Wood', 'Yang Earth': 'Yang Fire', 'Yin Earth': 'Yin Fire', 'Yang Metal': 'Yang Earth', 'Yin Metal': 'Yin Earth', 'Yang Water': 'Yang Metal', 'Yin Water': 'Yin Metal'}, jeongJae: {'Yang Wood': 'Yin Earth', 'Yin Wood': 'Yang Earth', 'Yang Fire': 'Yin Metal', 'Yin Fire': 'Yang Metal', 'Yang Earth': 'Yin Water', 'Yin Earth': 'Yang Water', 'Yang Metal': 'Yin Wood', 'Yin Metal': 'Yang Wood', 'Yang Water': 'Yin Fire', 'Yin Water': 'Yang Fire'}, pyeonJae: {'Yang Wood': 'Yang Earth', 'Yin Wood': 'Yin Earth', 'Yang Fire': 'Yang Metal', 'Yin Fire': 'Yin Metal', 'Yang Earth': 'Yang Water', 'Yin Earth': 'Yin Water', 'Yang Metal': 'Yang Wood', 'Yin Metal': 'Yin Wood', 'Yang Water': 'Yang Fire', 'Yin Water': 'Yin Fire'}, jeongGwan: {'Yang Wood': 'Yin Metal', 'Yin Wood': 'Yang Metal', 'Yang Fire': 'Yin Water', 'Yin Fire': 'Yang Water', 'Yang Earth': 'Yin Wood', 'Yin Earth': 'Yang Wood', 'Yang Metal': 'Yin Fire', 'Yin Metal': 'Yang Fire', 'Yang Water': 'Yin Earth', 'Yin Water': 'Yang Earth'}, pyeonGwan: {'Yang Wood': 'Yang Metal', 'Yin Wood': 'Yin Metal', 'Yang Fire': 'Yang Water', 'Yin Fire': 'Yin Water', 'Yang Earth': 'Yang Wood', 'Yin Earth': 'Yin Wood', 'Yang Metal': 'Yang Fire', 'Yin Metal': 'Yin Fire', 'Yang Water': 'Yang Earth', 'Yin Water': 'Yin Earth'} };
        const unsungScores = { 'Ïû•ÏÉù': 50, 'Î™©Ïöï': -40, 'Í¥ÄÎåÄ': 30, 'Í±¥Î°ù': 60, 'Ï†úÏôï': 70, 'Ïá†': -20, 'Î≥ë': -50, 'ÏÇ¨': -60, 'Î¨ò': -65, 'Ï†à': -70, 'ÌÉú': 0, 'Ïñë': 10 };
        const jangSaengPos = { 'Yang Wood': 'Pig', 'Yin Wood': 'Horse', 'Yang Fire': 'Tiger', 'Yin Fire': 'Rooster', 'Yang Earth': 'Tiger', 'Yin Earth': 'Rooster', 'Yang Metal': 'Snake', 'Yin Metal': 'Rat', 'Yang Water': 'Monkey', 'Yin Water': 'Rabbit' };
        const unsungOrder = ['Ïû•ÏÉù', 'Î™©Ïöï', 'Í¥ÄÎåÄ', 'Í±¥Î°ù', 'Ï†úÏôï', 'Ïá†', 'Î≥ë', 'ÏÇ¨', 'Î¨ò', 'Ï†à', 'ÌÉú', 'Ïñë'];
        const jiOrder = ['Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'];
        let solarTermsData = null;

        async function loadSolarTermsData() {
            try {
                const response = await fetch('solar_terms.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                solarTermsData = await response.json();
                return true;
            } catch (error) {
                console.error('Ï†àÏûÖÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                solarTermsData = null;
                return false;
            }
        }

        function normalizeIndex(index, mod) { return ((index % mod) + mod) % mod; }

        function calculateSaju() {
            const dayInput = document.getElementById('dayInput').value;
            const monthInput = document.getElementById('monthInput').value;
            const yearInput = document.getElementById('yearInput').value;
            const genderInput = document.getElementById('genderInput').value;
            const timeInput = document.getElementById('timeInput').value;
            
            if (!dayInput || !monthInput || !yearInput) {
                alert('Please select all date fields.');
                return;
            }
            
            if (!solarTermsData) {
                alert('Ï†àÏûÖÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞(solar_terms.json)Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const timeValue = timeInput || '12:00';
            const selectedDate = new Date(`${yearInput}-${monthInput.padStart(2, '0')}-${dayInput.padStart(2, '0')}T${timeValue}`);
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth() + 1;
            const day = selectedDate.getDate();
            const hour = selectedDate.getHours();
            
            let adjustedDate = new Date(year, month - 1, day);
            if (hour === 23) adjustedDate = new Date(year, month - 1, day + 1);
            
            const baseDate = new Date(2025, 5, 9);
            const daysDiff = Math.floor((adjustedDate - baseDate) / (1000 * 60 * 60 * 24));
            const baseDayGan = 5, baseDayZhi = 9;
            const dayGan = normalizeIndex(baseDayGan + daysDiff, 10);
            const dayZhi = normalizeIndex(baseDayZhi + daysDiff, 12);
            
            const baseYearGan = 1, baseYearZhi = 5;
            let solarYear = year;
            const lichunDate = getMonthStartDate(year, 1);
            if (lichunDate && selectedDate < lichunDate) solarYear = year - 1;
            
            const yearOffset = solarYear - 2025;
            const yearGan = normalizeIndex(baseYearGan + yearOffset, 10);
            const yearZhi = normalizeIndex(baseYearZhi + yearOffset, 12);
            
            const monthNumber = getSolarMonth(selectedDate);
            if (monthNumber === null) {
                alert(`${year}ÎÖÑÎèÑÏùò Ï†àÏûÖÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.`);
                return;
            }
            
            const yearGanMod5 = yearGan % 5;
            let monthGanBase;
            switch(yearGanMod5) {
                case 0: case 5: monthGanBase = 2; break;
                case 1: case 6: monthGanBase = 4; break;
                case 2: case 7: monthGanBase = 6; break;
                case 3: case 8: monthGanBase = 8; break;
                case 4: case 9: monthGanBase = 0; break;
            }
            
            const monthGan = normalizeIndex(monthGanBase + (monthNumber - 1), 10);
            const monthZhi = normalizeIndex(2 + (monthNumber - 1), 12);
            
            let hourGan = null, hourZhi = null;
            if (timeInput) {
                let hourIndex = Math.floor((hour + 1) / 2) % 12;
                if (hour === 23) hourIndex = 0;
                const hourGanBase = (dayGan % 5) * 2;
                hourGan = normalizeIndex(hourGanBase + hourIndex, 10);
                hourZhi = hourIndex;
            }
            
            const yearStemText = tianGanEn[yearGan];
            const yearBranchText = diZhiEn[yearZhi];
            const monthStemText = tianGanEn[monthGan];
            const monthBranchText = diZhiEn[monthZhi];
            const dayStemText = tianGanEn[dayGan];
            const dayBranchText = diZhiEn[dayZhi];
            
            let hourStemText = '', hourBranchText = '';
            if (timeInput && hourGan !== null && hourZhi !== null) {
                hourStemText = tianGanEn[hourGan];
                hourBranchText = diZhiEn[hourZhi];
            }
            
            updateCell('yearStem', yearStemText, 'stem-cell');
            updateCell('monthStem', monthStemText, 'stem-cell');
            updateCell('dayStem', dayStemText, 'stem-cell');
            updateCell('hourStem', hourStemText, 'stem-cell');
            updateCell('yearBranch', yearBranchText, 'branch-cell');
            updateCell('monthBranch', monthBranchText, 'branch-cell');
            updateCell('dayBranch', dayBranchText, 'branch-cell');
            updateCell('hourBranch', hourBranchText, 'branch-cell');
            
            document.getElementById('selectedDate').textContent = `${year}/${month}/${day}` + (timeInput ? ` ${hour}:${timeValue.split(':')[1] || '00'}` : ' (No time entered)') + (hour === 23 ? ' (Using next day\'s day pillar)' : '');
            
            if (genderInput) {
                calculateAndDisplayFortune(selectedDate, genderInput, yearGan, monthGan, monthZhi);
                document.getElementById('fortuneCard').style.display = 'block';
            } else {
                document.getElementById('fortuneCard').style.display = 'none';
            }
            
            calculateAndDisplayYearlyFortune();
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('inseongSection').style.display = 'block';
            
            window.currentPillars = { day: dayStemText, year: yearStemText + yearBranchText, month: monthStemText + monthBranchText };
            window.currentGender = genderInput;
        }

        function getSolarMonth(date) {
            const year = date.getFullYear();
            const transitions = solarTermsData[year] || [];
            if (transitions.length === 0) return null;
            const firstTransition = new Date(year, transitions[0].month - 1, transitions[0].day, transitions[0].hour, transitions[0].minute);
            if (date < firstTransition) return 12;
            for (let i = transitions.length - 1; i >= 0; i--) {
                const trans = transitions[i];
                const transDate = new Date(year, trans.month - 1, trans.day, trans.hour, trans.minute);
                if (date >= transDate) return i;
            }
            return null;
        }

        function getMonthStartDate(year, monthNum) {
            const transitions = solarTermsData[year];
            if (!transitions || monthNum < 1 || monthNum > 12) return null;
            if (monthNum === 12) {
                const prevTransitions = solarTermsData[year - 1];
                if (prevTransitions && prevTransitions.length >= 11) {
                    const trans = prevTransitions[10];
                    return new Date(year - 1, trans.month - 1, trans.day, trans.hour, trans.minute);
                }
            } else if (monthNum <= transitions.length) {
                const trans = transitions[monthNum - 1];
                return new Date(year, trans.month - 1, trans.day, trans.hour, trans.minute);
            }
            return null;
        }

        function updateCell(elementId, text, cellType) {
            const element = document.getElementById(elementId);
            element.textContent = text || '-';
            if (text && wuxing[text]) {
                element.className = `grid-cell ${cellType} ${elementClass[wuxing[text]]}`;
            } else {
                element.className = `grid-cell ${cellType}`;
                if (!text) {
                    element.style.border = '2px dashed rgba(255,255,255,0.5)';
                    element.style.background = 'transparent';
                }
            }
        }

        function calculateAndDisplayFortune(birthDate, gender, yearGan, monthGan, monthZhi) {
            // ÎåÄÏö¥ Í≥ÑÏÇ∞ Î°úÏßÅ (Í∞ÑÎã®Ìôî)
            const birthYear = birthDate.getFullYear();
            const currentYear = new Date().getFullYear();
            const isYangYear = yearGan % 2 === 0;
            const isForward = (gender === 'male' && isYangYear) || (gender === 'female' && !isYangYear);
            const yearTransitions = solarTermsData[birthYear];
let daysToSolarTerm = 3 * 365; // Í∏∞Î≥∏Í∞í

if (yearTransitions) {
    // ÏÉùÏùº Í∏∞Ï§ÄÏúºÎ°ú Ïù¥Ï†Ñ/Îã§Ïùå Ï†àÏûÖÏãúÍ∞Ñ Ï∞æÍ∏∞
    let prevTransition = null;
    let nextTransition = null;
    
    for (let i = 0; i < yearTransitions.length; i++) {
        const transDate = new Date(birthYear, yearTransitions[i].month - 1, yearTransitions[i].day, yearTransitions[i].hour, yearTransitions[i].minute);
        if (transDate <= birthDate) {
            prevTransition = transDate;
        } else {
            nextTransition = transDate;
            break;
        }
    }
    
    if (isForward && nextTransition) {
        daysToSolarTerm = (nextTransition - birthDate) / (1000 * 60 * 60 * 24);
    } else if (!isForward && prevTransition) {
        daysToSolarTerm = (birthDate - prevTransition) / (1000 * 60 * 60 * 24);
    }
}

const fortuneStartAge = daysToSolarTerm / 3;
const fortuneStartYear = birthYear + Math.round(fortuneStartAge);
            const currentFortuneIndex = Math.floor((currentYear - fortuneStartYear) / 10);
            
            const fortunes = [];
            for (let i = -1; i <= 1; i++) {
                const fortuneIndex = currentFortuneIndex + i;
                const startYear = fortuneStartYear + (fortuneIndex * 10);
                const endYear = startYear + 9;
                let fortuneGan, fortuneZhi;
                if (isForward) {
                    fortuneGan = normalizeIndex(monthGan + fortuneIndex + 1, 10);
                    fortuneZhi = normalizeIndex(monthZhi + fortuneIndex + 1, 12);
                } else {
                    fortuneGan = normalizeIndex(monthGan - fortuneIndex - 1, 10);
                    fortuneZhi = normalizeIndex(monthZhi - fortuneIndex - 1, 12);
                }
                const fortuneType = i === -1 ? 'past' : (i === 0 ? 'current' : 'future');
                const fortuneLabel = i === -1 ? 'Previous' : (i === 0 ? 'Current' : 'Next');
                fortunes.push({ type: fortuneType, label: fortuneLabel, startYear, endYear, gan: fortuneGan, zhi: fortuneZhi });
            }
            
            let fortuneHtml = `<div style="font-size: 0.9em; margin-bottom: 10px; opacity: 0.8;">${gender === 'male' ? 'Male' : 'Female'}, ${isYangYear ? 'Yang' : 'Yin'} year ‚Üí ${isForward ? 'Forward' : 'Backward'}</div>`;
            fortunes.forEach(fortune => {
                const ganText = tianGanEn[fortune.gan];
                const zhiText = diZhiEn[fortune.zhi];
                const ganElement = wuxing[ganText];
                const zhiElement = wuxing[zhiText];
                fortuneHtml += `<div class="fortune-period fortune-${fortune.type}"><div class="fortune-title">${fortune.label} Fortune</div><div>${fortune.startYear} - ${fortune.endYear}</div><div class="fortune-elements"><span class="fortune-element ${elementClass[ganElement]}">${ganText}</span><span class="fortune-element ${elementClass[zhiElement]}">${zhiText}</span></div></div>`;
            });
            document.getElementById('fortuneInfo').innerHTML = fortuneHtml;
        }

        function calculateAndDisplayYearlyFortune() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];
            const yearLabels = ['Last Year', 'This Year', 'Next Year'];
            const yearTypes = ['past', 'current', 'future'];
            const base2025Gan = 1, base2025Zhi = 5;
            let yearlyHtml = '';
            years.forEach((year, index) => {
                const yearOffset = year - 2025;
                const yearGan = normalizeIndex(base2025Gan + yearOffset, 10);
                const yearZhi = normalizeIndex(base2025Zhi + yearOffset, 12);
                const ganText = tianGanEn[yearGan];
                const zhiText = diZhiEn[yearZhi];
                const ganElement = wuxing[ganText];
                const zhiElement = wuxing[zhiText];
                yearlyHtml += `<div class="fortune-period fortune-${yearTypes[index]}"><div class="fortune-title">${yearLabels[index]}</div><div>${year}</div><div class="fortune-elements"><span class="fortune-element ${elementClass[ganElement]}">${ganText}</span><span class="fortune-element ${elementClass[zhiElement]}">${zhiText}</span></div></div>`;
            });
            document.getElementById('yearlyInfo').innerHTML = yearlyHtml;
        }

        function calculateInseongUnsung(ilgan, ganzhi) {
            const jeongIn = sipsinMapping.jeongIn[ilgan];
            if (!jeongIn) return 0;
            let ji = '';
            for (let animal of diZhiEn) {
                if (ganzhi.includes(animal)) { ji = animal; break; }
            }
            const jangSaeng = jangSaengPos[jeongIn];
            if (!jangSaeng || !ji) return 0;
            const jangSaengIndex = jiOrder.indexOf(jangSaeng);
            const jiIndex = jiOrder.indexOf(ji);
            if (jangSaengIndex === -1 || jiIndex === -1) return 0;
            const isYinGan = tianGanEn.indexOf(jeongIn) % 2 === 1;
            let diff = (jiIndex - jangSaengIndex + 12) % 12;
            if (isYinGan) diff = (12 - diff) % 12;
            const unsung = unsungOrder[diff];
            return unsungScores[unsung] || 0;
        }

        function calculateSipsinUnsung(sipsin, ganzhi) {
            let ji = '';
            for (let animal of diZhiEn) {
                if (ganzhi.includes(animal)) { ji = animal; break; }
            }
            const jangSaeng = jangSaengPos[sipsin];
            if (!jangSaeng || !ji) return 0;
            const jangSaengIndex = jiOrder.indexOf(jangSaeng);
            const jiIndex = jiOrder.indexOf(ji);
            if (jangSaengIndex === -1 || jiIndex === -1) return 0;
            const isYinGan = tianGanEn.indexOf(sipsin) % 2 === 1;
            let diff = (jiIndex - jangSaengIndex + 12) % 12;
            if (isYinGan) diff = (12 - diff) % 12;
            const unsung = unsungOrder[diff];
            return unsungScores[unsung] || 0;
        }

        function calculateWealthUnsung(ilgan, ganzhi) {
            const jeongJae = sipsinMapping.jeongJae[ilgan];
            const pyeonJae = sipsinMapping.pyeonJae[ilgan];
            let totalScore = 0;
            if (jeongJae) totalScore += calculateSipsinUnsung(jeongJae, ganzhi);
            if (pyeonJae) totalScore += calculateSipsinUnsung(pyeonJae, ganzhi);
            return totalScore / 2;
        }

        function calculateCareerUnsung(ilgan, ganzhi) {
            const jeongGwan = sipsinMapping.jeongGwan[ilgan];
            const pyeonGwan = sipsinMapping.pyeonGwan[ilgan];
            let totalScore = 0;
            if (jeongGwan) totalScore += calculateSipsinUnsung(jeongGwan, ganzhi);
            if (pyeonGwan) totalScore += calculateSipsinUnsung(pyeonGwan, ganzhi);
            return totalScore / 2;
        }

        function calculateLoveUnsung(ilgan, ganzhi, gender) {
            if (gender === 'male') {
                const jeongJae = sipsinMapping.jeongJae[ilgan];
                return jeongJae ? calculateSipsinUnsung(jeongJae, ganzhi) : 0;
            } else {
                const jeongGwan = sipsinMapping.jeongGwan[ilgan];
                return jeongGwan ? calculateSipsinUnsung(jeongGwan, ganzhi) : 0;
            }
        }

        function generateYearMonthGanzhi(startYear, endYear) {
            const result = [];
            for (let year = startYear; year <= endYear; year++) {
                const baseYearGan = 1, baseYearZhi = 5;
                const yearOffset = year - 2025;
                const yearGan = normalizeIndex(baseYearGan + yearOffset, 10);
                const yearZhi = normalizeIndex(baseYearZhi + yearOffset, 12);
                const yearGanzhi = tianGanEn[yearGan] + diZhiEn[yearZhi];
                for (let month = 1; month <= 12; month++) {
                    const yearGanMod5 = yearGan % 5;
                    let monthGanBase;
                    switch(yearGanMod5) {
                        case 0: case 5: monthGanBase = 2; break;
                        case 1: case 6: monthGanBase = 4; break;
                        case 2: case 7: monthGanBase = 6; break;
                        case 3: case 8: monthGanBase = 8; break;
                        case 4: case 9: monthGanBase = 0; break;
                    }
                    const monthGan = normalizeIndex(monthGanBase + (month - 1), 10);
                    const monthZhi = normalizeIndex(2 + (month - 1), 12);
                    const monthGanzhi = tianGanEn[monthGan] + diZhiEn[monthZhi];
                    result.push({ year: year, month: month, yearGanzhi: yearGanzhi, monthGanzhi: monthGanzhi });
                }
            }
            return result;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showStudyFortune() {
            if (!window.currentPillars) { alert('Please calculate Four Pillars first.'); return; }
            const currentYear = new Date().getFullYear();
            const rangeYears = parseInt(document.getElementById('analysisRange').value);
            const startYear = currentYear - Math.floor(rangeYears / 2);
            const endYear = currentYear + Math.floor(rangeYears / 2);
            const ilgan = window.currentPillars.day;
            const yearMonthData = generateYearMonthGanzhi(startYear, endYear);
            const scores = [], labels = [];
            yearMonthData.forEach(data => {
                const yearScore = calculateInseongUnsung(ilgan, data.yearGanzhi);
                const monthScore = calculateInseongUnsung(ilgan, data.monthGanzhi);
                const totalScore = yearScore * 0.7 + monthScore * 0.3;
                scores.push(Math.round((totalScore + 100) * 10) / 10);
                labels.push(`${data.year}.${data.month.toString().padStart(2, '0')}`);
            });
            drawGraph(labels, scores, 'Study Fortune Analysis', 'fortuneChart');
        }

        function showWealthFortune() {
            if (!window.currentPillars) { alert('Please calculate Four Pillars first.'); return; }
            const currentYear = new Date().getFullYear();
            const rangeYears = parseInt(document.getElementById('analysisRange').value);
            const startYear = currentYear - Math.floor(rangeYears / 2);
            const endYear = currentYear + Math.floor(rangeYears / 2);
            const ilgan = window.currentPillars.day;
            const yearMonthData = generateYearMonthGanzhi(startYear, endYear);
            const scores = [], labels = [];
            yearMonthData.forEach(data => {
                const yearScore = calculateWealthUnsung(ilgan, data.yearGanzhi);
                const monthScore = calculateWealthUnsung(ilgan, data.monthGanzhi);
                const totalScore = yearScore * 0.7 + monthScore * 0.3;
                scores.push(Math.round((totalScore + 100) * 10) / 10);
                labels.push(`${data.year}.${data.month.toString().padStart(2, '0')}`);
            });
            drawGraph(labels, scores, 'Wealth Fortune Analysis', 'wealthChart');
        }

        function showCareerFortune() {
            if (!window.currentPillars) { alert('Please calculate Four Pillars first.'); return; }
            const currentYear = new Date().getFullYear();
            const rangeYears = parseInt(document.getElementById('analysisRange').value);
            const startYear = currentYear - Math.floor(rangeYears / 2);
            const endYear = currentYear + Math.floor(rangeYears / 2);
            const ilgan = window.currentPillars.day;
            const yearMonthData = generateYearMonthGanzhi(startYear, endYear);
            const scores = [], labels = [];
            yearMonthData.forEach(data => {
                const yearScore = calculateCareerUnsung(ilgan, data.yearGanzhi);
                const monthScore = calculateCareerUnsung(ilgan, data.monthGanzhi);
                const totalScore = yearScore * 0.7 + monthScore * 0.3;
                scores.push(Math.round((totalScore + 100) * 10) / 10);
                labels.push(`${data.year}.${data.month.toString().padStart(2, '0')}`);
            });
            drawGraph(labels, scores, 'Career Fortune Analysis', 'careerChart');
        }

        function showLoveFortune() {
            if (!window.currentPillars || !window.currentGender) { alert('Please calculate Four Pillars and select gender first.'); return; }
            const currentYear = new Date().getFullYear();
            const rangeYears = parseInt(document.getElementById('analysisRange').value);
            const startYear = currentYear - Math.floor(rangeYears / 2);
            const endYear = currentYear + Math.floor(rangeYears / 2);
            const ilgan = window.currentPillars.day;
            const gender = window.currentGender;
            const yearMonthData = generateYearMonthGanzhi(startYear, endYear);
            const scores = [], labels = [];
            yearMonthData.forEach(data => {
                const yearScore = calculateLoveUnsung(ilgan, data.yearGanzhi, gender);
                const monthScore = calculateLoveUnsung(ilgan, data.monthGanzhi, gender);
                const totalScore = yearScore * 0.7 + monthScore * 0.3;
                scores.push(Math.round((totalScore + 100) * 10) / 10);
                labels.push(`${data.year}.${data.month.toString().padStart(2, '0')}`);
            });
            drawGraph(labels, scores, 'Love Fortune Analysis', 'loveChart');
        }

        function drawGraph(labels, scores, title, chartId) {
            const canvas = document.getElementById(chartId);
            const ctx = canvas.getContext('2d');
            canvas.style.display = 'block';
            canvas.width = 800; canvas.height = 400;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const padding = 80, graphWidth = canvas.width - padding * 2, graphHeight = canvas.height - padding * 2;
            const minScore = Math.min(...scores), maxScore = Math.max(...scores), scoreRange = Math.max(maxScore - minScore, 10);
            ctx.fillStyle = '#f8f9fa'; ctx.fillRect(padding, padding, graphWidth, graphHeight);
            ctx.strokeStyle = '#e0e0e0'; ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = padding + (i / 10) * graphWidth, y = padding + (i / 10) * graphHeight;
                ctx.beginPath(); ctx.moveTo(x, padding); ctx.lineTo(x, padding + graphHeight); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + graphWidth, y); ctx.stroke();
            }
            ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.beginPath();
            ctx.moveTo(padding, padding); ctx.lineTo(padding, padding + graphHeight); ctx.lineTo(padding + graphWidth, padding + graphHeight); ctx.stroke();
            const baselineY = padding + graphHeight - ((100 - minScore) / scoreRange) * graphHeight;
            if (baselineY >= padding && baselineY <= padding + graphHeight) {
                ctx.strokeStyle = '#ff6b6b'; ctx.lineWidth = 2; ctx.setLineDash([10, 5]);
                ctx.beginPath(); ctx.moveTo(padding, baselineY); ctx.lineTo(padding + graphWidth, baselineY); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle = '#ff6b6b'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'right'; ctx.fillText('100', padding - 5, baselineY + 4);
            }
            if (scores.length > 1) {
                ctx.strokeStyle = '#667eea'; ctx.lineWidth = 3; ctx.beginPath();
                for (let i = 0; i < scores.length; i++) {
                    const x = padding + (i / (scores.length - 1)) * graphWidth;
                    const y = padding + graphHeight - ((scores[i] - minScore) / scoreRange) * graphHeight;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.fillStyle = '#667eea';
                scores.forEach((score, index) => {
                    const pointX = padding + (index / (scores.length - 1)) * graphWidth;
                    const pointY = padding + graphHeight - ((score - minScore) / scoreRange) * graphHeight;
                    ctx.beginPath(); ctx.arc(pointX, pointY, 4, 0, 2 * Math.PI); ctx.fill();
                });
            }
            ctx.fillStyle = '#333'; ctx.font = '12px Arial'; ctx.textAlign = 'center';
            const currentYear = new Date().getFullYear();
            const rangeYears = parseInt(document.getElementById('analysisRange').value);
            const startYear = currentYear - Math.floor(rangeYears / 2);
            const endYear = currentYear + Math.floor(rangeYears / 2);
            const yearRange = endYear - startYear;
            for (let i = 0; i <= yearRange; i++) {
                const year = startYear + i;
                const x = padding + (i / yearRange) * graphWidth;
                ctx.fillText(year.toString(), x, canvas.height - padding + 25);
            }
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const score = minScore + (scoreRange * i / 5);
                const y = padding + graphHeight - (i / 5) * graphHeight;
                ctx.fillText(score.toFixed(0), padding - 10, y + 4);
            }
            ctx.fillStyle = '#2c3e50'; ctx.font = 'bold 18px Arial'; ctx.textAlign = 'center'; ctx.fillText(title, canvas.width / 2, 30);
            ctx.font = '12px Arial'; ctx.textAlign = 'left';
            const avgScore = scores.reduce((a,b) => a+b, 0) / scores.length;
            ctx.fillText(`Range: ${minScore.toFixed(0)} ~ ${maxScore.toFixed(0)} (Avg: ${avgScore.toFixed(1)}, Baseline: 100)`, padding, canvas.height - 10);
        }

        window.onload = async function() {
            const loadSuccess = await loadSolarTermsData();
            if (!loadSuccess) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = '‚ö†Ô∏è Ï†àÏûÖÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÌååÏùº(solar_terms.json)ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.<br>Ï†ïÌôïÌïú ÏÇ¨Ï£º Í≥ÑÏÇ∞ÏùÑ ÏúÑÌï¥ÏÑúÎäî Ïù¥ ÌååÏùºÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.';
                document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.input-section'));
            }
            const daySelect = document.getElementById('dayInput');
            daySelect.innerHTML = '<option value="">Day</option>';
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = i;
                if (i === 10) option.selected = true;
                daySelect.appendChild(option);
            }
            const monthSelect = document.getElementById('monthInput');
            monthSelect.innerHTML = '<option value="">Month</option>';
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = months[i-1];
                if (i === 6) option.selected = true;
                monthSelect.appendChild(option);
            }
            const yearSelect = document.getElementById('yearInput');
            yearSelect.innerHTML = '<option value="">Year</option>';
            for (let i = 2026; i >= 1939; i--) {
                const option = document.createElement('option');
                option.value = i; option.textContent = i;
                if (i === 2025) option.selected = true;
                yearSelect.appendChild(option);
            }
        };
    </script>
</body>
</html>